{{/* The docker pull image secret */}}
{{- with .Values.imagePullSecret }}
---
apiVersion: v1
kind: Secret
type: kubernetes.io/dockerconfigjson
metadata:
  name: image-pull-secret
  namespace: {{ include "install.namespace" $ }}
  labels:
    {{- include "application.labels" $ | nindent 4 }}
    {{- include "application.selectorLabels" (merge (dict "name" "image-pull-secret") $) | nindent 4 }}
data:
  .dockerconfigjson: {{ include "imagePullSecret.dockerConfig" . | b64enc }}
{{- end }}

{{/* Set ICC generic secrets */}}
{{- with .Values.services.icc.secrets }}
---
apiVersion: v1
kind: Secret
type: Opaque
metadata:
  name: icc
  namespace: {{ include "install.namespace" $ }}
  labels:
    {{- include "application.labels" $ | nindent 4 }}
data:
  {{- range $secret, $val := . }}
  {{ $secret }}: {{ $val | b64enc }}
  {{- end }}
{{- end }}

{{/* Add all enabled ICC login methods */}}

{{- with .Values.services.icc.login_methods.google_oauth }}
{{- if .enable }}
---
apiVersion: v1
kind: Secret
type: Opaque
metadata:
  name: icc-google-oauth
  namespace: {{ include "install.namespace" $ }}
  labels:
    {{- include "application.labels" $ | nindent 4 }}
    {{- include "application.selectorLabels" (merge (dict "name" "icc-google-oauth") $) | nindent 4 }}
data:
  client_id: {{ .client_id | b64enc }}
  client_secret: {{ .client_secret | b64enc }}
{{- end }}
{{- end }}

{{- with .Values.services.icc.login_methods.github_oauth }}
{{- if .enable }}
---
apiVersion: v1
kind: Secret
type: Opaque
metadata:
  name: icc-github-oauth
  namespace: {{ include "install.namespace" $ }}
  labels:
    {{- include "application.labels" $ | nindent 4 }}
    {{- include "application.selectorLabels" (merge (dict "name" "icc-github-oauth") $) | nindent 4 }}
data:
  client_id: {{ .client_id | b64enc }}
  client_secret: {{ .client_secret | b64enc }}
{{- end }}
{{- end }}

{{/* Setup databases */}}
{{- if $.Values.services.icc.database_url }}
---
apiVersion: v1
kind: Secret
type: Opaque
metadata:
  name: icc-databases
  namespace: {{ include "install.namespace" $ }}
  labels:
    {{- include "application.labels" $ | nindent 4 }}
data:
  {{- range (include "service.icc.databases" . | trim | split " ") }}
  "{{ . }}": {{ printf "%s/%s" $.Values.services.icc.database_url . | b64enc }}
  {{- end }}
{{- end }}

{{/* Setup valkey */}}
{{- with $.Values.services.icc.valkey }}
---
apiVersion: v1
kind: Secret
type: Opaque
metadata:
  name: icc-valkey
  namespace: {{ include "install.namespace" $ }}
  labels:
    {{- include "application.labels" $ | nindent 4 }}
data:
  {{- with .apps_url }}
  apps: {{ . | b64enc }}
  {{- end }}
  {{- with .icc_url }}
  icc: {{ . | b64enc }}
  {{- end }}
{{- end }}
